program Apatchee1;

{$APPTYPE CONSOLE}

uses
  SysUtils,
  uniteServeur in 'uniteServeur.pas';

uses

// Conversion d'un string en entier et vérifier si un interval est respecté
// @param min, max: les bornes de l'interval
// @param nbrChaine: la chaine de caractère à convertire

function valideEntier( min, max: Integer; nbrChaine: String; ): Integer;
var nombre, controle : integer;
begin
  // Désactive le contrôle des erreurs d'E/S
  {$I-}

  nombre := StrToInt( nbrChaine );
  controle := IOResult;
  if ( controle <> 0 ) or ( nombre < min ) or ( nombre > max ) then
    writeln( 'Le numéro de port doit respecter l''interval [',min,'..',max,']' );

  // Active le contrôle des erreurs d'E/S
  {$I+}
  result := nombre;
end;


var
  numeroDuPort: Word;
  leServeur: Serveur;


begin
  // validation de la configuration
  // ParamCount retourne le nombre de sous chaines dans une chaine de caractère
  case paramCount of

    // Cas où l'utilisateur n'utilise pas l'option ( -p ou -P )
    0: numeroDuPort := 80;

    // Cas où l'utilisateur saisie seulement l'option ( -p ou -P )
    // ou toute autre caractère sans le numéro de port
    1: begin
         // ParamStr retourne le contenu d'une sous chaîne
         if ( paramStr(1) = '-p' ) or ( paramStr(1) = '-P' ) then
         begin
           writeln( 'Vous devez saisir un numéro de port compris entre [ 1 et 65 535 ]' );
           halt;
         end

         else
         begin
           writeln( 'Vous devez saisir -p ou -P suivi du numéro de port compris entre [ 1 et 65 535 ]' );
           halt;
         end;
       end;

    // Pour vérifier que l'utilisateur a configuré le serveur
    // avec l'option -p ou -P et avec un numéro de port compris entre [ 1 et 65 535 ]
    2: begin
         if ( paramStr(1) <> '-p' ) and ( paramStr(1) <> '-P' ) then
         begin
           writeln( 'Vous devez saisir -p ou -P suivi du numéro de port compris entre [ 1 et 65 535 ]' );
           halt;
         end

         else
         begin
           valideEntier(1,65535,paramStr(2));
           halt;
         end;
       end;

  end; // Fin de case

  // Instanciation du serveur
  leServeur := Serveur.create;

  // L'intialisation du serveur via un numéro de port
  leServeur.initialiser(numeroDuPort);

  // Démarrage du serveur
  leServeur.demarrer;
end.

